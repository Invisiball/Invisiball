(function(){var t=t||{};this.Int32Array||(this.Int32Array=Array,this.Float32Array=Array),t.Broadphase=function(){this.world=null},t.Broadphase.prototype.constructor=t.BroadPhase,t.Broadphase.prototype.collisionPairs=function(){throw"collisionPairs not implemented for this BroadPhase class!"},t.NaiveBroadphase=function(){this.temp={r:new t.Vec3,normal:new t.Vec3,quat:new t.Quaternion,relpos:new t.Vec3}},t.NaiveBroadphase.prototype=new t.Broadphase,t.NaiveBroadphase.prototype.constructor=t.NaiveBroadphase,t.NaiveBroadphase.prototype.collisionPairs=function(e){for(var i=[],n=[],o=e.numObjects(),a=e.bodies,r=t.Shape.types,s=r.SPHERE|r.BOX|r.COMPOUND|r.CONVEXPOLYHEDRON,h=r.PLANE,c=t.Body.STATIC|t.Body.KINEMATIC,u=this.temp,l=u.r,p=u.normal,v=(u.quat,u.relpos),d=0;o>d;d++)for(var f=0;d>f;f++){var y=a[d],m=a[f];if(0===(y.motionstate&c)&&!y.isSleeping()||0===(m.motionstate&c)&&!m.isSleeping()){var w=y.shape,b=m.shape;if(w&&b){var x=w.type,V=b.type;if(x&s&&V&s){m.position.vsub(y.position,l),w.boundingSphereRadiusNeedsUpdate&&w.computeBoundingSphereRadius(),b.boundingSphereRadiusNeedsUpdate&&b.computeBoundingSphereRadius();var g=w.boundingSphereRadius+b.boundingSphereRadius;l.norm2()<g*g&&(i.push(y),n.push(m))}else if(x&s&&V&r.PLANE||V&s&&x&r.PLANE){var E=x===h?d:f,z=x!==h?d:f;a[z].position.vsub(a[E].position,l),p.set(0,0,1),a[E].quaternion.vmult(p,p),a[z].shape.boundingSphereRadiusNeedsUpdate&&a[z].shape.computeBoundingSphereRadius();var S=l.dot(p)-a[z].shape.boundingSphereRadius;0>S&&(i.push(y),n.push(m))}}else if(w||b){var q=w?m:y,M=w?y:m,j=M.shape,N=j.type;if(N&s){if(N===r.SPHERE)q.position.vsub(M.position,v),j.radius*j.radius>=v.norm2()&&(i.push(q),n.push(M));else if(N===r.CONVEXPOLYHEDRON||N===r.BOX||N===r.COMPOUND){j.boundingSphereRadiusNeedsUpdate&&j.computeBoundingSphereRadius();var C=j.boundingSphereRadius;q.position.vsub(M.position,v),C*C>=v.norm2()&&(i.push(q),n.push(M))}}else if(N===r.PLANE){var P=M;p.set(0,0,1),P.quaternion.vmult(p,p),q.position.vsub(P.position,v),p.dot(v)<=0&&(i.push(q),n.push(M))}}else;}}return[i,n]},t.Ray=function(e,i){function n(t,e,i){return i.vsub(t,g),p=g.dot(e),e.mult(p,E),E.vadd(t,E),v=i.distanceTo(E)}function o(t,e,i,n){return n.vsub(e,g),i.vsub(e,z),t.vsub(e,S),d=g.dot(g),f=g.dot(z),y=g.dot(S),m=z.dot(z),w=z.dot(S),b=1/(d*m-f*f),x=(m*y-f*w)*b,V=(d*w-f*y)*b,x>=0&&V>=0&&1>x+V}this.origin=e||new t.Vec3,this.direction=i||new t.Vec3;var a=1e-4;this.setPrecision=function(t){a=t};var r=new t.Vec3,s=new t.Vec3,h=new t.Vec3,c=(new t.Vec3,new t.Vec3,new t.Vec3),u=new t.Vec3,l=new t.Vec3;this.intersectBody=function(e){return e.shape instanceof t.ConvexPolyhedron?this.intersectShape(e.shape,e.quaternion,e.position,e):e.shape instanceof t.Box?this.intersectShape(e.shape.convexPolyhedronRepresentation,e.quaternion,e.position,e):void console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes.")},this.intersectShape=function(e,i,p,v){var d,f=[];if(e instanceof t.ConvexPolyhedron){var y=n(this.origin,this.direction,p);if(y>e.boundingSphereRadius())return f;var m,w,b=e.faces,x=e.vertices,V=e.faceNormals;for(fi=0;fi<b.length;fi++){var g=b[fi],E=V[fi],z=i,S=p;if(x[g[0]].copy(c),z.vmult(c,c),c.vadd(S,c),c.vsub(this.origin,c),z.vmult(E,u),m=this.direction.dot(u),!(Math.abs(m)<a)&&(w=u.dot(c)/m,!(0>w)&&0>m)){this.direction.mult(w,l),l.vadd(this.origin,l),x[g[0]].copy(r),z.vmult(r,r),S.vadd(r,r);for(var q=1;q<g.length-1;q++)if(x[g[q]].copy(s),x[g[q+1]].copy(h),z.vmult(s,s),z.vmult(h,h),S.vadd(s,s),S.vadd(h,h),o(l,r,s,h)){d={distance:this.origin.distanceTo(l),point:l.copy(),face:g,body:v},f.push(d);break}}}}return f},this.intersectBodies=function(t){for(var e=[],i=0,n=t.length;n>i;i++){var o=this.intersectBody(t[i]);Array.prototype.push.apply(e,o)}return e.sort(function(t,e){return t.distance-e.distance}),e};var p,v,d,f,y,m,w,b,x,V,g=new t.Vec3,E=new t.Vec3,z=new t.Vec3,S=new t.Vec3},t.Ray.prototype.constructor=t.Ray,t.Mat3=function(t){this.elements=t?t:[0,0,0,0,0,0,0,0,0]},t.Mat3.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},t.Mat3.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},t.Mat3.prototype.setTrace=function(t){this.elements[0]=t.x,this.elements[4]=t.y,this.elements[8]=t.z},t.Mat3.prototype.vmult=function(e,i){i=i||new t.Vec3;var n=this.elements,o=e.x,a=e.y,r=e.z;return i.x=n[0]*o+n[1]*a+n[2]*r,i.y=n[3]*o+n[4]*a+n[5]*r,i.z=n[6]*o+n[7]*a+n[8]*r,i},t.Mat3.prototype.smult=function(t){for(var e=0;e<this.elements.length;e++)this.elements[e]*=t},t.Mat3.prototype.mmult=function(e){for(var i=new t.Mat3,n=0;3>n;n++)for(var o=0;3>o;o++){for(var a=0,r=0;3>r;r++)a+=e.elements[n+3*r]*this.elements[r+3*o];i.elements[n+3*o]=a}return i},t.Mat3.prototype.solve=function(e,i){i=i||new t.Vec3;for(var n=3,o=4,a=[],r=0;n*o>r;r++)a.push(0);var r,s;for(r=0;3>r;r++)for(s=0;3>s;s++)a[r+o*s]=this.elements[r+3*s];a[3]=e.x,a[7]=e.y,a[11]=e.z;var h,c,u=3,l=u,p=4;do{if(r=l-u,0===a[r+o*r])for(s=r+1;l>s;s++)if(0!==a[r+o*s]){h=p;do c=p-h,a[c+o*r]+=a[c+o*s];while(--h);break}if(0!==a[r+o*r])for(s=r+1;l>s;s++){var v=a[r+o*s]/a[r+o*r];h=p;do c=p-h,a[c+o*s]=r>=c?0:a[c+o*s]-a[c+o*r]*v;while(--h)}}while(--u);if(i.z=a[2*o+3]/a[2*o+2],i.y=(a[1*o+3]-a[1*o+2]*i.z)/a[1*o+1],i.x=(a[0*o+3]-a[0*o+2]*i.z-a[0*o+1]*i.y)/a[0*o+0],isNaN(i.x)||isNaN(i.y)||isNaN(i.z)||1/0===i.x||1/0===i.y||1/0===i.z)throw"Could not solve equation! Got x=["+i.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return i},t.Mat3.prototype.e=function(t,e,i){return void 0===i?this.elements[e+3*t]:void(this.elements[e+3*t]=i)},t.Mat3.prototype.copy=function(e){e=e||new t.Mat3;for(var i=0;i<this.elements.length;i++)e.elements[i]=this.elements[i];return e},t.Mat3.prototype.toString=function(){for(var t="",e=",",i=0;9>i;i++)t+=this.elements[i]+e;return t},t.Mat3.prototype.reverse=function(e){e=e||new t.Mat3;for(var i=3,n=6,o=[],a=0;i*n>a;a++)o.push(0);var a,r;for(a=0;3>a;a++)for(r=0;3>r;r++)o[a+n*r]=this.elements[a+3*r];o[3]=1,o[9]=0,o[15]=0,o[4]=0,o[10]=1,o[16]=0,o[5]=0,o[11]=0,o[17]=1;var s,h,c=3,u=c,l=n;do{if(a=u-c,0===o[a+n*a])for(r=a+1;u>r;r++)if(0!==o[a+n*r]){s=l;do h=l-s,o[h+n*a]+=o[h+n*r];while(--s);break}if(0!==o[a+n*a])for(r=a+1;u>r;r++){var p=o[a+n*r]/o[a+n*a];s=l;do h=l-s,o[h+n*r]=a>=h?0:o[h+n*r]-o[h+n*a]*p;while(--s)}}while(--c);a=2;do{r=a-1;do{var p=o[a+n*r]/o[a+n*a];s=n;do h=n-s,o[h+n*r]=o[h+n*r]-o[h+n*a]*p;while(--s)}while(r--)}while(--a);a=2;do{var p=1/o[a+n*a];s=n;do h=n-s,o[h+n*a]=o[h+n*a]*p;while(--s)}while(a--);a=2;do{r=2;do{if(h=o[i+r+n*a],isNaN(h)||1/0===h)throw"Could not reverse! A=["+this.toString()+"]";e.e(a,r,h)}while(r--)}while(a--);return e};var e=0;t.Vec3=function(t,i,n){this.x=t||0,this.y=i||0,this.z=n||0,e++},t.Vec3.prototype.cross=function(e,i){var n=e.x,o=e.y,a=e.z,r=this.x,s=this.y,h=this.z;i=i||new t.Vec3;[this.x,this.y,this.z],[e.x,e.y,e.z];return i.x=s*a-h*o,i.y=h*n-r*a,i.z=r*o-s*n,i},t.Vec3.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},t.Vec3.prototype.vadd=function(e,i){return i?(i.x=e.x+this.x,i.y=e.y+this.y,i.z=e.z+this.z,void 0):new t.Vec3(this.x+e.x,this.y+e.y,this.z+e.z)},t.Vec3.prototype.vsub=function(e,i){return i?(i.x=this.x-e.x,i.y=this.y-e.y,i.z=this.z-e.z,void 0):new t.Vec3(this.x-e.x,this.y-e.y,this.z-e.z)},t.Vec3.prototype.crossmat=function(){return new t.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},t.Vec3.prototype.normalize=function(){var t=this.x,e=this.y,i=this.z,n=Math.sqrt(t*t+e*e+i*i);if(n>0){var o=1/n;this.x*=o,this.y*=o,this.z*=o}else this.x=0,this.y=0,this.z=0;return n},t.Vec3.prototype.unit=function(e){e=e||new t.Vec3;var i=this.x,n=this.y,o=this.z,a=Math.sqrt(i*i+n*n+o*o);return a>0?(a=1/a,e.x=i*a,e.y=n*a,e.z=o*a):(e.x=1,e.y=0,e.z=0),e},t.Vec3.prototype.norm=function(){var t=this.x,e=this.y,i=this.z;return Math.sqrt(t*t+e*e+i*i)},t.Vec3.prototype.norm2=function(){return this.dot(this)},t.Vec3.prototype.distanceTo=function(t){var e=this.x,i=this.y,n=this.z,o=t.x,a=t.y,r=t.z;return Math.sqrt((o-e)*(o-e)+(a-i)*(a-i)+(r-n)*(r-n))},t.Vec3.prototype.mult=function(e,i){return i||(i=new t.Vec3),i.x=e*this.x,i.y=e*this.y,i.z=e*this.z,i},t.Vec3.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.Vec3.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},t.Vec3.prototype.negate=function(e){return e=e||new t.Vec3,e.x=-this.x,e.y=-this.y,e.z=-this.z,e};var n=new t.Vec3,o=new t.Vec3;t.Vec3.prototype.tangents=function(t,e){var i=this.norm();if(i>0){var a=n,r=1/i;a.set(this.x*r,this.y*r,this.z*r);var s=o;Math.abs(a.x)<.9?(s.set(1,0,0),a.cross(s,t)):(s.set(0,1,0),a.cross(s,t)),a.cross(t,e)}else t.set(1,0,0).normalize(),e.set(0,1,0).normalize()},t.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z},t.Vec3.prototype.copy=function(e){return e=e||new t.Vec3,e.x=this.x,e.y=this.y,e.z=this.z,e},t.Vec3.prototype.lerp=function(t,e,i){var n=this.x,o=this.y,a=this.z;i.x=n+(t.x-n)*e,i.y=o+(t.y-o)*e,i.z=a+(t.z-a)*e},t.Vec3.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e?!1:!0},t.Vec3.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t?!1:!0},t.Quaternion=function(t,e,i,n){this.x=void 0!=t?t:0,this.y=void 0!=e?e:0,this.z=void 0!=i?i:0,this.w=void 0!=n?n:1},t.Quaternion.prototype.set=function(t,e,i,n){this.x=t,this.y=e,this.z=i,this.w=n},t.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},t.Quaternion.prototype.setFromAxisAngle=function(t,e){var i=Math.sin(.5*e);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(.5*e)},t.Quaternion.prototype.toAxisAngle=function(e){e=e||new t.Vec3,this.normalize();var i=2*Math.acos(this.w),n=Math.sqrt(1-this.w*this.w);return.001>n?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/n,e.y=this.y/n,e.z=this.z/n),[e,i]},t.Quaternion.prototype.setFromVectors=function(t,e){var i=t.cross(e);this.x=i.x,this.y=i.y,this.z=i.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()};var a=new t.Vec3,r=new t.Vec3,s=new t.Vec3;t.Quaternion.prototype.mult=function(e,i){var n=this.w;return void 0==i&&(i=new t.Quaternion),a.set(this.x,this.y,this.z),r.set(e.x,e.y,e.z),i.w=n*e.w-a.dot(r),a.cross(r,s),i.x=n*r.x+e.w*a.x+s.x,i.y=n*r.y+e.w*a.y+s.y,i.z=n*r.z+e.w*a.z+s.z,i},t.Quaternion.prototype.inverse=function(e){var i=this.x,n=this.y,o=this.z,a=this.w;void 0==e&&(e=new t.Quaternion),this.conjugate(e);var r=1/(i*i+n*n+o*o+a*a);return e.x*=r,e.y*=r,e.z*=r,e.w*=r,e},t.Quaternion.prototype.conjugate=function(e){return void 0==e&&(e=new t.Quaternion),e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},t.Quaternion.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.vmult=function(e,i){if(i=i||new t.Vec3,0==this.w)i.x=e.x,i.y=e.y,i.z=e.z;else{var n=e.x,o=e.y,a=e.z,r=this.x,s=this.y,h=this.z,c=this.w,u=c*n+s*a-h*o,l=c*o+h*n-r*a,p=c*a+r*o-s*n,v=-r*n-s*o-h*a;i.x=u*c+v*-r+l*-h-p*-s,i.y=l*c+v*-s+p*-r-u*-h,i.z=p*c+v*-h+u*-s-l*-r}return i},t.Quaternion.prototype.copy=function(t){t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w},t.Quaternion.prototype.toEuler=function(t,e){e=e||"YZX";var i,n,o,a=this.x,r=this.y,s=this.z,h=this.w;switch(e){case"YZX":var c=a*r+s*h;if(c>.499&&(i=2*Math.atan2(a,h),n=Math.PI/2,o=0),-.499>c&&(i=-2*Math.atan2(a,h),n=-Math.PI/2,o=0),isNaN(i)){var u=a*a,l=r*r,p=s*s;i=Math.atan2(2*r*h-2*a*s,1-2*l-2*p),n=Math.asin(2*c),o=Math.atan2(2*a*h-2*r*s,1-2*u-2*p)}break;default:throw new Error("Euler order "+e+" not supported yet.")}t.y=i,t.z=n,t.x=o},t.Shape=function(){this.type=0,this.aabbmin=new t.Vec3,this.aabbmax=new t.Vec3,this.boundingSphereRadius=0,this.boundingSphereRadiusNeedsUpdate=!0},t.Shape.prototype.constructor=t.Shape,t.Shape.prototype.computeBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},t.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},t.Shape.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},t.Shape.prototype.calculateTransformedInertia=function(e,i,n){void 0==n&&(n=new t.Vec3),i.normalize();var o=new t.Vec3;this.calculateLocalInertia(e,o);var a=i.vmult(o);return n.x=Math.abs(a.x),n.y=Math.abs(a.y),n.z=Math.abs(a.z),n},t.Shape.calculateLocalAABB=function(){throw new Error(".calculateLocalAABB is not implemented for this Shape yet!")},t.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16},t.Body=function(e){t.EventTarget.apply(this),this.type=e;this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new t.Vec3},t.Body.DYNAMIC=1,t.Body.STATIC=2,t.Body.KINEMATIC=4,t.Particle=function(e,i){if("number"!=typeof e)throw new Error("Argument 1 (mass) must be a number.");if("undefined"!=typeof i&&!(i instanceof t.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Body.call(this,"particle");var n=this;this.position=new t.Vec3,this.initPosition=new t.Vec3,this.velocity=new t.Vec3,this.initVelocity=new t.Vec3,this.force=new t.Vec3,this.mass=e,this.invMass=e>0?1/e:0,this.material=i,this.linearDamping=.01,this.motionstate=0>=e?t.Body.STATIC:t.Body.DYNAMIC,this.allowSleep=!0,this.sleepState=0,this.isAwake=function(){return 0==n.sleepState},this.isSleepy=function(){return 1==n.sleepState},this.isSleeping=function(){return 2==n.sleepState},this.sleepSpeedLimit=.1,this.sleepTimeLimit=1,this.timeLastSleepy=0,this.wakeUp=function(){n.sleepState=0,n.dispatchEvent({type:"wakeup"})},this.sleep=function(){n.sleepState=2},this.sleepTick=function(t){if(n.allowSleep){var e=n.sleepState,i=n.velocity.norm2(),o=Math.pow(n.sleepSpeedLimit,2);0==e&&o>i?(n.sleepState=1,n.timeLastSleepy=t,n.dispatchEvent({type:"sleepy"})):1==e&&i>o?n.wakeUp():1==e&&t-n.timeLastSleepy>n.sleepTimeLimit&&(n.sleepState=2,n.dispatchEvent({type:"sleep"}))}}},t.RigidBody=function(e,i,n){if("number"!=typeof e)throw new Error("Argument 1 (mass) must be a number.");if("undefined"!=typeof n&&!(n instanceof t.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Particle.call(this,e,n);this.tau=new t.Vec3,this.quaternion=new t.Quaternion,this.initQuaternion=new t.Quaternion,this.angularVelocity=new t.Vec3,this.initAngularVelocity=new t.Vec3,this.shape=i,this.inertia=new t.Vec3,i.calculateLocalInertia(e,this.inertia),this.inertiaWorld=new t.Vec3,this.inertia.copy(this.inertiaWorld),this.inertiaWorldAutoUpdate=!1,this.invInertia=new t.Vec3(this.inertia.x>0?1/this.inertia.x:0,this.inertia.y>0?1/this.inertia.y:0,this.inertia.z>0?1/this.inertia.z:0),this.invInertiaWorld=new t.Vec3,this.invInertia.copy(this.invInertiaWorld),this.invInertiaWorldAutoUpdate=!1,this.angularDamping=.01,this.aabbmin=new t.Vec3,this.aabbmax=new t.Vec3,this.calculateAABB(),this.wlambda=new t.Vec3},t.RigidBody.constructor=t.RigidBody,t.RigidBody.prototype.calculateAABB=function(){this.shape.calculateWorldAABB(this.position,this.quaternion,this.aabbmin,this.aabbmax)},t.RigidBody.prototype.applyImpulse=function(e,i,n){n=n||1/60;var o=new t.Vec3,a=new t.Vec3;e.vsub(this.position,o),o.cross(i,a),this.velocity.vadd(i.mult(n),this.velocity),this.angularVelocity.vadd(a.mult(n),this.angularVelocity)},t.Sphere=function(e){t.Shape.call(this),this.radius=void 0!=e?Number(e):1,this.type=t.Shape.types.SPHERE},t.Sphere.prototype=new t.Shape,t.Sphere.prototype.constructor=t.Sphere,t.Sphere.prototype.calculateLocalInertia=function(e,i){i=i||new t.Vec3;var n=2*e*this.radius*this.radius/5;return i.x=n,i.y=n,i.z=n,i},t.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3},t.Sphere.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadiusNeedsUpdate=!1,this.boundingSphereRadius=this.radius},t.Sphere.prototype.calculateWorldAABB=function(t,e,i,n){for(var o=this.radius,a=["x","y","z"],r=0;r<a.length;r++){var s=a[r];i[s]=t[s]-o,n[s]=t[s]+o}},t.Box=function(e){t.Shape.call(this),this.halfExtents=e,this.type=t.Shape.types.BOX,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation()},t.Box.prototype=new t.Shape,t.Box.prototype.constructor=t.Box,t.Box.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,i=this.halfExtents.y,n=this.halfExtents.z,o=t.Vec3,a=new t.ConvexPolyhedron([new o(-e,-i,-n),new o(e,-i,-n),new o(e,i,-n),new o(-e,i,-n),new o(-e,-i,n),new o(e,-i,n),new o(e,i,n),new o(-e,i,n)],[[0,1,2,3],[4,5,6,7],[0,1,5,4],[2,3,7,6],[0,3,7,4],[1,2,6,5]],[new o(0,0,-1),new o(0,0,1),new o(0,-1,0),new o(0,1,0),new o(-1,0,0),new o(1,0,0)]);this.convexPolyhedronRepresentation=a},t.Box.prototype.calculateLocalInertia=function(e,i){i=i||new t.Vec3;var n=this.halfExtents;return i.x=1/12*e*(2*n.y*2*n.y+2*n.z*2*n.z),i.y=1/12*e*(2*n.x*2*n.x+2*n.z*2*n.z),i.z=1/12*e*(2*n.y*2*n.y+2*n.x*2*n.x),i},t.Box.prototype.getSideNormals=function(t,e){var i=t,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!=e)for(var o=0;o<i.length;o++)e.vmult(i[o],i[o]);return i},t.Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},t.Box.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm(),this.boundingSphereRadiusNeedsUpdate=!1};{var h=new t.Vec3;new t.Vec3}t.Box.prototype.forEachWorldCorner=function(t,e,i){for(var n=this.halfExtents,o=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],a=0;a<o.length;a++)h.set(o[a][0],o[a][1],o[a][2]),e.vmult(h,h),t.vadd(h,h),i(h.x,h.y,h.z)},t.Box.prototype.calculateWorldAABB=function(t,e,i,n){i.set(1/0,1/0,1/0),n.set(-1/0,-1/0,-1/0),this.forEachWorldCorner(t,e,function(t,e,o){t>n.x&&(n.x=t),e>n.y&&(n.y=e),o>n.z&&(n.z=o),t<i.x&&(i.x=t),e<i.y&&(i.y=e),o<i.z&&(i.z=o)})},t.Plane=function(){t.Shape.call(this),this.type=t.Shape.types.PLANE},t.Plane.prototype=new t.Shape,t.Plane.prototype.constructor=t.Plane,t.Plane.prototype.calculateLocalInertia=function(e,i){return i=i||new t.Vec3},t.Plane.prototype.volume=function(){return 1/0};var c=new t.Vec3(0,0,1);t.Plane.prototype.calculateWorldAABB=function(t,e,i,n){e.vmult(c,c),i.set(1/0,1/0,1/0);for(var o=["x","y","z"],a=0;a<o.length;a++){var r=o[a];1==c[r]&&(n[r]=t[r]),-1==c[r]&&(i[r]=t[r])}},t.Compound=function(){t.Shape.call(this),this.type=t.Shape.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]},t.Compound.prototype=new t.Shape,t.Compound.prototype.constructor=t.Compound,t.Compound.prototype.addChild=function(e,i,n){i=i||new t.Vec3,n=n||new t.Quaternion,this.childShapes.push(e),this.childOffsets.push(i),this.childOrientations.push(n)},t.Compound.prototype.volume=function(){for(var t=0,e=0;e<this.childShapes.length;e++)t+=this.childShapes[e].volume();return t};var u=new t.Vec3,l=new t.Vec3;t.Compound.prototype.calculateLocalInertia=function(e,i){i=i||new t.Vec3;for(var n=this.volume(),o=l,a=0,r=this.childShapes.length;a!==r;a++){var s=this.childShapes[a],h=this.childOffsets[a],c=(this.childOrientations[a],s.volume()/n*e);s.calculateLocalInertia(c,o),i.vadd(o,i);var p=u;p.set(c*h.x*h.x,c*h.y*h.y,c*h.z*h.z),i.vadd(p,i)}return i},t.Compound.prototype.computeBoundingSphereRadius=function(){for(var t=0,e=0;e<this.childShapes.length;e++){var i=this.childShapes[e];i.boundingSphereRadiusNeedsUpdate&&i.computeBoundingSphereRadius();var n=this.childOffsets[e].norm()+i.boundingSphereRadius;n>t&&(t=n)}this.boundingSphereRadius=t,this.boundingSphereRadiusNeedsUpdate=!1};var p=new t.Vec3,v=new t.Vec3,d=new t.Vec3,f=new t.Quaternion;t.Compound.prototype.calculateWorldAABB=function(t,e,i,n){var o=this.childShapes.length;i.set(1/0,1/0,1/0),n.set(-1/0,-1/0,-1/0);for(var a=0;o>a;a++)this.childOffsets[a].copy(d),e.vmult(d,d),t.vadd(d,d),e.mult(this.childOrientations[a],f),this.childShapes[a].calculateWorldAABB(d,f,v,p),v.x<i.x&&(i.x=v.x),v.y<i.y&&(i.y=v.y),v.z<i.z&&(i.z=v.z),p.x>n.x&&(n.x=p.x),p.y>n.y&&(n.y=p.y),p.z>n.z&&(n.z=p.z)},t.ConvexPolyhedron=function(e,i,n){function o(t,e,i,n,o){for(var a=t.vertices.length,r=null,s=null,h=t.vertices,c=0;a>c;c++){h[c].copy(w),n.vmult(w,w),w.vadd(i,w);var u=w.dot(e);(null===r||u>r)&&(r=u),(null===s||s>u)&&(s=u)}if(s>r){var l=s;s=r,r=l}o[0]=r,o[1]=s}function a(t){var e=r.faces[t],i=r.faceNormals[t],n=r.vertices[e[0]],o=-i.dot(n);return o}var r=this;t.Shape.call(this),this.type=t.Shape.types.CONVEXPOLYHEDRON,this.vertices=e||[],this.faces=i||[],this.faceNormals=n||[];for(var s=0;s<this.faceNormals.length;s++)this.faceNormals[s].normalize();this.uniqueEdges=[];for(var h=this.vertices.length,c=0;h>c;c++){var u=this.vertices[c];if(!(u instanceof t.Vec3))throw"Argument 1 must be instance of CANNON.Vec3";this.uniqueEdges.push(u)}for(var s=0;s<this.faces.length;s++)for(var l=this.faces[s].length,p=l,v=0;p>v;v++){var d=(v+1)%l,f=new t.Vec3;this.vertices[this.faces[s][v]].vsub(this.vertices[this.faces[s][d]],f),f.normalize();for(var y=!1,u=0;u<this.uniqueEdges.length;u++)if(this.uniqueEdges[u].almostEquals(f)||this.uniqueEdges[u].almostEquals(f)){y=!0;break}if(y||this.uniqueEdges.push(f),f)f.face1=s;else{var m;m.m_face0=s,edges.insert(vp,m)}}var w=new t.Vec3;this.testSepAxis=function(t,e,i,n,a,r){var s=[],h=[],c=this;o(c,t,i,n,s),o(e,t,a,r,h);var u=s[0],l=s[1],p=h[0],v=h[1];if(v>u||l>p)return!1;var d=u-v,f=p-l;return depth=f>d?d:f};var b=new t.Vec3,x=new t.Vec3,V=new t.Vec3,g=new t.Vec3,E=new t.Vec3,z=new t.Vec3;this.findSeparatingAxis=function(t,e,i,n,o,a){for(var r=1/0,s=this,h=0,c=s.faces.length,u=0;c>u;u++){s.faceNormals[u].copy(b),i.vmult(b,b);var l=s.testSepAxis(b,t,e,i,n,o);if(l===!1)return!1;r>l&&(r=l,b.copy(a))}for(var p=t.faces.length,u=0;p>u;u++){t.faceNormals[u].copy(x),o.vmult(x,x),h++;var l=s.testSepAxis(x,t,e,i,n,o);if(l===!1)return!1;r>l&&(r=l,x.copy(a))}for(var v=0,d=0;d<s.uniqueEdges.length;d++){s.uniqueEdges[d].copy(g),i.vmult(g,g);for(var f=0;f<t.uniqueEdges.length;f++)if(t.uniqueEdges[f].copy(E),o.vmult(E,E),g.cross(E,z),v++,!z.almostZero()){z.normalize();var y=s.testSepAxis(z,t,e,i,n,o);if(y===!1)return!1;r>y&&(r=y,z.copy(a))}}return n.vsub(e,V),V.dot(a)>0&&a.negate(a),!0};var S=new t.Vec3;this.clipAgainstHull=function(e,i,n,o,a,r,s,h,c){if(!(e instanceof t.Vec3))throw new Error("posA must be Vec3");if(!(i instanceof t.Quaternion))throw new Error("quatA must be Quaternion");for(var u=-1,l=-1/0,p=0;p<n.faces.length;p++){n.faceNormals[p].copy(S),a.vmult(S,S);var v=S.dot(r);v>l&&(l=v,u=p)}var d=[];polyB=n.faces[u];for(var f=polyB.length,y=0;f>y;y++){var m=n.vertices[polyB[y]],w=new t.Vec3;m.copy(w),a.vmult(w,w),o.vadd(w,w),d.push(w)}u>=0&&this.clipFaceAgainstHull(r,e,i,d,s,h,c)};var q=new t.Vec3,M=new t.Vec3,j=new t.Vec3,N=new t.Vec3,C=new t.Vec3,P=new t.Vec3,O=new t.Vec3,A=new t.Vec3;this.clipFaceAgainstHull=function(e,i,n,o,r,s,h){if(!(e instanceof t.Vec3))throw new Error("sep normal must be vector");if(!(o instanceof Array))throw new Error("world verts must be array");r=Number(r),s=Number(s);for(var c=this,u=[],l=o,p=u,v=-1,d=1/0,f=0;f<c.faces.length;f++){c.faceNormals[f].copy(q),n.vmult(q,q);var y=q.dot(e);d>y&&(d=y,v=f)}if(0>v)return void console.log("--- did not find any closest face... ---");var m=c.faces[v];m.connectedFaces=[];for(var w=0;w<c.faces.length;w++)for(var b=0;b<c.faces[w].length;b++)-1!==m.indexOf(c.faces[w][b])&&w!==v&&-1===m.connectedFaces.indexOf(w)&&m.connectedFaces.push(w);for(var x=(l.length,m.length),V=0;x>V;V++){var g=c.vertices[m[V]],E=c.vertices[m[(V+1)%x]];g.vsub(E,M),M.copy(j),n.vmult(j,j),i.vadd(j,j),this.faceNormals[v].copy(N),n.vmult(N,N),i.vadd(N,N),j.cross(N,C),C.negate(C),g.copy(P),n.vmult(P,P),i.vadd(P,P);var z,S=(-P.dot(C),m.connectedFaces[V]);this.faceNormals[S].copy(O);var I=a(S);O.copy(A),n.vmult(A,A);var z=I-A.dot(i);for(this.clipFaceAgainstPlane(l,p,A,z);l.length;)l.shift();for(;p.length;)l.push(p.shift())}this.faceNormals[v].copy(O);var I=a(v);O.copy(A),n.vmult(A,A);for(var z=I-A.dot(i),w=0;w<l.length;w++){var B=A.dot(l[w])+z;if(r>=B&&(console.log("clamped: depth="+B+" to minDist="+(r+"")),B=r),s>=B){var R=l[w];if(0>=B){var T={point:R,normal:A,depth:B};h.push(T)}}}},this.clipFaceAgainstPlane=function(e,i,n,o){if(!(n instanceof t.Vec3))throw new Error("planeNormal must be Vec3, "+n+" given");if(!(e instanceof Array))throw new Error("invertices must be Array, "+e+" given");if(!(i instanceof Array))throw new Error("outvertices must be Array, "+i+" given");var a,r,s=e.length;if(2>s)return i;var h=e[e.length-1],c=e[0];a=n.dot(h)+o;for(var u=0;s>u;u++){if(c=e[u],r=n.dot(c)+o,0>a)if(0>r){var l=new t.Vec3;c.copy(l),i.push(l)}else{var l=new t.Vec3;h.lerp(c,a/(a-r),l),i.push(l)}else if(0>r){var l=new t.Vec3;h.lerp(c,a/(a-r),l),i.push(l),i.push(c)}h=c,a=r}return i};{var r=this;new t.Vec3,new t.Vec3}this.calculateLocalInertia=function(t,e){r.computeAABB();var i=this.aabbmax.x-this.aabbmin.x,n=this.aabbmax.y-this.aabbmin.y,o=this.aabbmax.z-this.aabbmin.z;e.x=1/12*t*(2*n*2*n+2*o*2*o),e.y=1/12*t*(2*i*2*i+2*o*2*o),e.z=1/12*t*(2*n*2*n+2*i*2*i)};new t.Vec3;this.computeAABB=function(){var t=this.vertices.length,e=this.aabbmin,i=this.aabbmax,n=this.vertices;e.set(1/0,1/0,1/0),i.set(-1/0,-1/0,-1/0);for(var o=0;t>o;o++){var a=n[o];a.x<e.x?e.x=a.x:a.x>i.x&&(i.x=a.x),a.y<e.y?e.y=a.y:a.y>i.y&&(i.y=a.y),a.z<e.z?e.z=a.z:a.z>i.z&&(i.z=a.z)}}},t.ConvexPolyhedron.prototype=new t.Shape,t.ConvexPolyhedron.prototype.constructor=t.ConvexPolyhedron,t.ConvexPolyhedron.prototype.computeBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=0,n=e.length;i!==n;i++){var o=e[i].norm2();o>t&&(t=o)}this.boundingSphereRadius=Math.sqrt(t),this.boundingSphereRadiusNeedsUpdate=!1};var y=new t.Vec3;t.ConvexPolyhedron.prototype.calculateWorldAABB=function(t,e,i,n){for(var o,a,r,s,h,c,u=this.vertices.length,l=this.vertices,p=0;u>p;p++){l[p].copy(y),e.vmult(y,y),t.vadd(y,y);var v=y;v.x<o||void 0===o?o=v.x:(v.x>s||void 0===s)&&(s=v.x),v.y<a||void 0===a?a=v.y:(v.y>h||void 0===h)&&(h=v.y),v.z<r||void 0===r?r=v.z:(v.z>c||void 0===c)&&(c=v.z)}i.set(o,a,r),n.set(s,h,c)},t.ConvexPolyhedron.prototype.volume=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),4*Math.PI*this.boundingSphereRadius/3},t.ConvexPolyhedron.prototype.getAveragePointLocal=function(e){e=e||new t.Vec3;for(var i=this.vertices.length,n=this.vertices,o=0;i>o;o++)e.vadd(n[o],e);return e.mult(1/i,e),e},t.ConvexPolyhedron.prototype.transformAllPoints=function(t,e){var i=this.vertices.length,n=this.vertices;if(e)for(var o=0;i>o;o++){var a=n[o];e.vmult(a,a)}if(t)for(var o=0;i>o;o++){var a=n[o];a.vadd(t,a)}};var m=new t.Vec3,w=new t.Vec3,b=new t.Vec3;t.ConvexPolyhedron.prototype.pointIsInside=function(t){var e=this.vertices.length,i=this.vertices,n=this.faces,o=this.faceNormals,a=null,r=this.faces.length,s=m;this.getAveragePointLocal(s);for(var h=0;r>h;h++){var e=(this.faces[h].length,o[h]),c=i[n[h][0]],u=w;t.vsub(c,u);var l=e.dot(u),p=b;s.vsub(c,p);var v=e.dot(p);if(0>l&&v>0||l>0&&0>v)return!1}return a?1:-1},t.Cylinder=function(e,i,n,o){var a=o,r=[],s=[],h=[],c=[],u=[],l=Math.cos,p=Math.sin;r.push(new t.Vec3(i*l(0),i*p(0),.5*-n)),c.push(0),r.push(new t.Vec3(e*l(0),e*p(0),.5*n)),u.push(1);for(var v=0;a>v;v++){var d=2*Math.PI/a*(v+1),f=2*Math.PI/a*(v+.5);a-1>v?(r.push(new t.Vec3(i*l(d),i*p(d),.5*-n)),c.push(2*(v+1)),r.push(new t.Vec3(e*l(d),e*p(d),.5*n)),u.push(2*(v+1)+1),s.push(new t.Vec3(l(f),p(f),0)),h.push([2*v,2*v+1,2*(v+1),2*(v+1)+1])):(h.push([2*v,2*v+1,0,1]),s.push(new t.Vec3(l(f),p(f),0)))}h.push(u),s.push(new t.Vec3(0,0,1)),h.push(c),s.push(new t.Vec3(0,0,-1)),this.type=t.Shape.types.CONVEXPOLYHEDRON,t.ConvexPolyhedron.call(this,r,h,s)},t.Cylinder.prototype=new t.ConvexPolyhedron,t.Solver=function(){this.equations=[]},t.Solver.prototype.solve=function(){return 0},t.Solver.prototype.addEquation=function(t){this.equations.push(t)},t.Solver.prototype.removeEquation=function(t){var e=this.equations.indexOf(t);-1!=e&&this.equations.splice(e,1)},t.Solver.prototype.removeAllEquations=function(){this.equations=[]},t.GSSolver=function(){t.Solver.call(this),this.iterations=10,this.tolerance=0},t.GSSolver.prototype=new t.Solver,t.GSSolver.prototype.solve=function(t,e){for(var i=(this.d,this.k,0),n=this.iterations,o=this.tolerance*this.tolerance,a=(this.a,this.b),r=this.equations,s=r.length,h=e.bodies,c=e.bodies.length,u=t,l=[],p=[],v=[],d=0;d!==s;d++){var f=r[d];f.spookParamsNeedsUpdate&&(f.updateSpookParams(u),f.spookParamsNeedsUpdate=!1),v.push(0),p.push(f.computeB(u)),l.push(1/f.computeC())}var y,f,m,w,b,x,V;if(0!==s){var d,g,E=Math.abs;for(d=0;d!==c;d++){var a=h[d],z=a.vlambda,S=a.wlambda;z.set(0,0,0),S&&S.set(0,0,0)}for(i=0;i!==n;i++){for(b=0,g=0;g!==s;g++)f=r[g],y=p[g],m=l[g],V=v[g],x=f.computeGWlambda(f.eps),w=m*(y-x-f.eps*V),V+w<f.minForce?w=f.minForce-V:V+w>f.maxForce&&(w=f.maxForce-V),v[g]+=w,b+=E(w),f.addToWlambda(w);if(o>b*b)break}for(d=0;d!==c;d++){var a=h[d],q=a.velocity,M=a.angularVelocity;q.vadd(a.vlambda,q),M&&M.vadd(a.wlambda,M)}}return errorTot=b,i},t.SplitSolver=function(e){t.Solver.call(this),this.subsolver=e},t.SplitSolver.prototype=new t.Solver,t.SplitSolver.prototype.solve=function(e,i){function n(t){for(var e=t.length,i=0;e>i;i++){var n=t[i];if(!(n.visited||n.body.motionstate&w))return n}return!1}function o(t,e){var i=[];for(i.push(t),t.visited=!0,e(t);i.length;)for(var o,a=i.pop();o=n(a.children);)o.visited=!0,e(o),i.push(o)}for(var a=[],r=i.bodies,s=this.equations,h=s.length,c=r.length,u=this.subsolver,l=0;c>l;l++)a.push({body:r[l],children:[],eqs:[],visited:!1});for(var p=0;h>p;p++){var v=s[p],l=r.indexOf(v.bi),d=r.indexOf(v.bj),f=a[l],y=a[d];f.children.push(y),f.eqs.push(v),y.children.push(f),y.eqs.push(v)}for(var m,w=t.Body.STATIC,b=0;m=n(a);){var x=[],V=[];o(m,function(t){V.push(t.body);for(var e=0;e<t.eqs.length;e++)-1==x.indexOf(t.eqs[e])&&x.push(t.eqs[e])});for(var l=0;l<x.length;l++)u.addEquation(x[l]);{u.solve(e,{bodies:V})}u.removeAllEquations(),b++}return b},t.EventTarget=function(){var t={};this.addEventListener=function(e,i){void 0==t[e]&&(t[e]=[]),-1===t[e].indexOf(i)&&t[e].push(i)},this.dispatchEvent=function(e){for(var i in t[e.type])t[e.type][i](e)},this.removeEventListener=function(e,i){var n=t[e].indexOf(i);-1!==n&&t[e].splice(n,1)}},t.ObjectPool=function(){this.objects=[],this.type=Object},t.ObjectPool.prototype.release=function(){for(var t in arguments)this.objects.push(arguments[t])},t.ObjectPool.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},t.ObjectPool.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this ObjectPool subclass yet!")},t.Vec3Pool=function(){t.ObjectPool.call(this),this.type=t.Vec3},t.Vec3Pool.prototype=new t.ObjectPool,t.Vec3Pool.prototype.constructObject=function(){return new t.Vec3},t.Material=function(t){this.name=t,this.id=-1},t.ContactMaterial=function(t,e,i,n){this.id=-1,this.materials=[t,e],this.friction=void 0!=i?Number(i):.3,this.restitution=void 0!=n?Number(n):.3,this.contactEquationStiffness=1e7,this.contactEquationRegularizationTime=3,this.frictionEquationStiffness=1e7,this.frictionEquationRegularizationTime=3},t.World=function(){t.EventTarget.apply(this),this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.frictionEquationPool=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=new t.Vec3,this.broadphase=null,this.bodies=[];
this.solver=new t.GSSolver,this.constraints=[],this.contactgen=new t.ContactGenerator,this.collision_matrix=[],this.materials=[],this.contactmaterials=[],this.mats2cmat=[],this.defaultMaterial=new t.Material("default"),this.defaultContactMaterial=new t.ContactMaterial(this.defaultMaterial,this.defaultMaterial,.3,0),this.temp={gvec:new t.Vec3,vi:new t.Vec3,vj:new t.Vec3,wi:new t.Vec3,wj:new t.Vec3,t1:new t.Vec3,t2:new t.Vec3,rixn:new t.Vec3,rjxn:new t.Vec3,step_q:new t.Quaternion,step_w:new t.Quaternion,step_wq:new t.Quaternion},this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,nearphase:0}},t.World.prototype.getContactMaterial=function(e,i){if(e instanceof t.Material&&i instanceof t.Material){var n=e.id,o=i.id;if(o>n){var a=n;n=o,o=a}return this.contactmaterials[this.mats2cmat[n+o*this.materials.length]]}},t.World.prototype.numObjects=function(){return this.bodies.length},t.World.prototype.clearCollisionState=function(t){for(var e=this.numObjects(),i=t.id,n=0;e>n;n++){var o=n;i>o?cm[o+i*e]=0:cm[i+o*e]=0}},t.World.prototype.collisionMatrixGet=function(t,e,i){var n=this.bodies.length;if("undefined"==typeof i&&(i=!0),i&&e>t||!i&&t>e){var o=e;e=t,t=o}return this.collision_matrix[t+e*n]},t.World.prototype.collisionMatrixSet=function(t,e,i,n){var o=this.bodies.length;if("undefined"==typeof n&&(n=!0),n&&e>t||!n&&t>e){var a=e;e=t,t=a}this.collision_matrix[t+e*o]=i},t.World.prototype.collisionMatrixTick=function(){for(var t=this.bodies.length,e=0;t>e;e++)for(var i=0;e>i;i++){var n=this.collisionMatrixGet(e,i,!0);this.collisionMatrixSet(e,i,n,!1),this.collisionMatrixSet(e,i,0,!0)}},t.World.prototype.add=function(e){var i=this.numObjects();this.bodies.push(e),e.id=this.id(),e.world=this,e.position.copy(e.initPosition),e.velocity.copy(e.initVelocity),e.timeLastSleepy=this.time,e instanceof t.RigidBody&&(e.angularVelocity.copy(e.initAngularVelocity),e.quaternion.copy(e.initQuaternion));for(var n=0;2*i+1>n;n++)this.collision_matrix.push(0)},t.World.prototype.addConstraint=function(t){this.constraints.push(t),t.id=this.id()},t.World.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!=e&&this.constraints.splice(e,1)},t.World.prototype.id=function(){return this.nextId++},t.World.prototype.remove=function(t){t.world=null;var e=this.numObjects(),i=this.bodies;for(var n in i)i[n].id==t.id&&i.splice(n,1);for(var n=0;2*e-1>n;n++)this.collision_matrix.pop()},t.World.prototype.addMaterial=function(t){if(-1==t.id){var e=this.materials.length;this.materials.push(t),t.id=this.materials.length-1;for(var i,i,i=0;2*e+1>i;i++)this.mats2cmat.push(-1)}},t.World.prototype.addContactMaterial=function(t){this.addMaterial(t.materials[0]),this.addMaterial(t.materials[1]),t.materials[0].id>t.materials[1].id?(i=t.materials[0].id,j=t.materials[1].id):(j=t.materials[0].id,i=t.materials[1].id),this.contactmaterials.push(t),t.id=this.contactmaterials.length-1,this.mats2cmat[i+this.materials.length*j]=t.id},t.World.prototype._now=function(){return window.performance.webkitNow?window.performance.webkitNow():Date.now()},t.World.prototype.step=function(e){var i,n=this,o=this,a=this.numObjects(),r=this.bodies,s=this.solver,h=this.gravity,c=this.doProfiling,u=this.profile,l=t.Body.DYNAMIC,p=this._now,v=this.collision_matrix,d=this.constraints,f=t.FrictionEquation;c&&(i=p()),void 0===e&&(e=this.last_dt?this.last_dt:this.default_dt);for(var y=h.x,m=h.y,w=h.z,b=0;b!==a;b++){var x=r[b];if(x.motionstate&l){var V=x.force,g=x.mass;V.x+=g*y,V.y+=g*m,V.z+=g*w}}c&&(i=p());var E=this.broadphase.collisionPairs(this),z=E[0],S=E[1];c&&(u.broadphase=p()-i),this.collisionMatrixTick(),c&&(i=p());var q=this.contacts;this.contacts=[],this.contactgen.getContacts(z,S,this,this.contacts,q),c&&(u.nearphase=p()-i),c&&(i=p());var M=this.temp,j=this.contacts,N=j.length;this.frictionEquationPool=this.frictionEquationPool.concat(this.frictionEquations),this.frictionEquations=[];for(var C=0;C!==N;C++){var P=j[C],x=P.bi,O=P.bj,b=r.indexOf(x),A=r.indexOf(O),v=this.getContactMaterial(x.material,O.material)||this.defaultContactMaterial,I=v.friction,B=(v.restitution,M.gvec);B.set(O.position.x+P.rj.x-x.position.x-P.ri.x,O.position.y+P.rj.y-x.position.y-P.ri.y,O.position.z+P.rj.z-x.position.z-P.ri.z);var R=B.dot(P.ni);if(0>R){if(P.restitution=v.restitution,P.penetration=R,P.stiffness=v.contactEquationStiffness,P.regularizationTime=v.contactEquationRegularizationTime,s.addEquation(P),I>0){var T=I*h.norm(),F=x.invMass+O.invMass;0!=F&&(F=1/F);var L=this.frictionEquationPool,k=L.length?L.pop():new f(x,O,T*F),W=L.length?L.pop():new f(x,O,T*F);this.frictionEquations.push(k),this.frictionEquations.push(W),k.bi=W.bi=x,k.bj=W.bj=O,k.minForce=W.minForce=-T*F,k.maxForce=W.maxForce=T*F,P.ri.copy(k.ri),P.rj.copy(k.rj),P.ri.copy(W.ri),P.rj.copy(W.rj),P.ni.tangents(k.t,W.t),s.addEquation(k),s.addEquation(W)}this.collisionMatrixSet(b,A,1,!0),this.collisionMatrixGet(b,A,!0)!=this.collisionMatrixGet(b,A,!1)&&(x.dispatchEvent({type:"collide","with":O,contact:P}),O.dispatchEvent({type:"collide","with":x,contact:P}),x.wakeUp(),O.wakeUp())}}c&&(u.makeContactConstraints=p()-i);var x;c&&(i=p());for(var b=0,U=d.length;b!==U;b++){var P=d[b];P.update();for(var A=0,D=P.equations.length;A!==D;A++){var Q=P.equations[A];s.addEquation(Q)}}s.solve(e,n),c&&(u.solve=p()-i),s.removeAllEquations();for(var H=Math.pow,b=0;b!==a;b++)if(x=r[b],x.motionstate&l){var X=H(1-x.linearDamping,e),_=x.velocity;_.mult(X,_);var Y=x.angularVelocity;if(Y){var G=H(1-x.angularDamping,e);Y.mult(G,Y)}}o.dispatchEvent({type:"preStep"});for(var b=0;b!==a;b++){var x=r[b];x.preStep&&x.preStep.call(x)}c&&(i=p());for(var Z=(M.step_q,M.step_w),K=M.step_wq,J=n.stepnumber,$=t.Body.DYNAMIC|t.Body.KINEMATIC,te=J%(this.quatNormalizeSkip+1)===0,ee=this.quatNormalizeFast,ie=.5*e,b=0;b!==a;b++){var ne=r[b],oe=ne.force,ae=ne.tau;if(ne.motionstate&$){var re=ne.velocity,se=ne.angularVelocity,he=ne.position,ce=ne.quaternion,ue=ne.invMass,le=ne.invInertia;re.x+=oe.x*ue*e,re.y+=oe.y*ue*e,re.z+=oe.z*ue*e,ne.angularVelocity&&(se.x+=ae.x*le.x*e,se.y+=ae.y*le.y*e,se.z+=ae.z*le.z*e),ne.isSleeping()||(he.x+=re.x*e,he.y+=re.y*e,he.z+=re.z*e,ne.angularVelocity&&(Z.set(se.x,se.y,se.z,0),Z.mult(ce,K),ce.x+=ie*K.x,ce.y+=ie*K.y,ce.z+=ie*K.z,ce.w+=ie*K.w,te&&(ee?ce.normalizeFast():ce.normalize())))}ne.force.set(0,0,0),ne.tau&&ne.tau.set(0,0,0)}c&&(u.integrate=p()-i),this.time+=e,this.stepnumber+=1,o.dispatchEvent({type:"postStep"});for(var b=0;b!==a;b++){var x=r[b],pe=x.postStep;pe&&pe.call(x)}for(var b=0;b!==a;b++){var ne=r[b];ne.inertiaWorldAutoUpdate&&ne.quaternion.vmult(ne.inertia,ne.inertiaWorld),ne.invInertiaWorldAutoUpdate&&ne.quaternion.vmult(ne.invInertia,ne.invInertiaWorld)}if(n.allowSleep)for(var b=0;b!==a;b++)r[b].sleepTick(this.time)},t.ContactPoint=function(t,e,i,n,o,a){this.bi=t,this.bj=e,this.n=i,this.t1=o,this.t2=a,this.contactMaterial=n},t.ContactGenerator=function(){function e(e,i){if(y.length){var n=y.pop();return n.bi=e,n.bj=i,n}return new t.ContactEquation(e,i)}function i(t){var e;e=t.ri,t.ri=t.rj,t.rj=e,t.ni.negate(t.ni),e=t.bi,t.bi=t.bj,t.bj=e}function n(t,i,n,o,a,r,s,h,c){var u=e(h,c);c.position.vsub(o,u.ni),u.ni.normalize(),u.ni.copy(u.ri),u.ni.copy(u.rj),u.ri.mult(i.radius,u.ri),u.rj.mult(-n.radius,u.rj),t.push(u)}function o(t,i,n,o,a,r,s,h,c){var u=e(h,c);u.ni.set(0,0,1),s.vmult(u.ni,u.ni),u.ni.negate(u.ni),u.ni.normalize(),u.ni.mult(i.radius,u.ri),o.vsub(a,w),u.ni.mult(u.ni.dot(w),b),w.vsub(b,u.rj),b.norm2()<=i.radius*i.radius&&t.push(u)}function a(t,e,i){for(var n=null,o=t.length,a=0;o>a;a++){var r=t[a],s=x;t[(a+1)%o].vsub(r,s);var h=V;s.cross(e,h);var c=g;i.vsub(r,c);var u=h.dot(c);if(!(null===n||u>0&&n===!0||0>=u&&n===!1))return!1;null===n&&(n=u>0)}return!0}function r(t,i,n,o,a,r,s,h,c){var u=M;o.vsub(a,E),n.getSideNormals(u,s);for(var l=i.radius,p=!1,v=N,d=C,f=P,y=null,w=0,b=0,x=0,V=null,g=0,O=u.length;g!==O&&p===!1;g++){var A=z;u[g].copy(A);var I=A.norm();A.normalize();var B=E.dot(A);if(I+l>B&&B>0){var R=S,T=q;u[(g+1)%3].copy(R),u[(g+2)%3].copy(T);var F=R.norm(),L=T.norm();R.normalize(),T.normalize();var k=E.dot(R),W=E.dot(T);if(F>k&&k>-F&&L>W&&W>-L){var U=Math.abs(B-I-l);(null===V||V>U)&&(V=U,b=k,x=W,y=I,A.copy(v),R.copy(d),T.copy(f),w++)}}}if(w){p=!0;var D=e(h,c);v.mult(-l,D.ri),v.copy(D.ni),D.ni.negate(D.ni),v.mult(y,v),d.mult(b,d),v.vadd(d,v),f.mult(x,f),v.vadd(f,D.rj),t.push(D)}for(var Q=m.get(),H=j,X=0;2!==X&&!p;X++)for(var _=0;2!==_&&!p;_++)for(var Y=0;2!==Y&&!p;Y++)if(Q.set(0,0,0),X?Q.vadd(u[0],Q):Q.vsub(u[0],Q),_?Q.vadd(u[1],Q):Q.vsub(u[1],Q),Y?Q.vadd(u[2],Q):Q.vsub(u[2],Q),a.vadd(Q,H),H.vsub(o,H),H.norm2()<l*l){p=!0;var D=e(h,c);H.copy(D.ri),D.ri.normalize(),D.ri.copy(D.ni),D.ri.mult(l,D.ri),Q.copy(D.rj),t.push(D)}m.release(Q),Q=null;for(var G=m.get(),Z=m.get(),D=m.get(),K=m.get(),U=m.get(),J=u.length,X=0;J>X&&!p;X++)for(var _=0;J>_&&!p;_++)if(X%3!=_%3){u[_].cross(u[X],G),G.normalize(),u[X].vadd(u[_],Z),o.copy(D),D.vsub(Z,D),D.vsub(a,D);var $=D.dot(G);G.mult($,K);for(var Y=0;Y==X%3||Y==_%3;)Y++;o.copy(U),U.vsub(K,U),U.vsub(Z,U),U.vsub(a,U);var te=Math.abs($),ee=U.norm();if(te<u[Y].norm()&&l>ee){p=!0;var ie=e(h,c);Z.vadd(K,ie.rj),ie.rj.copy(ie.rj),U.negate(ie.ni),ie.ni.normalize(),ie.rj.copy(ie.ri),ie.ri.vadd(a,ie.ri),ie.ri.vsub(o,ie.ri),ie.ri.normalize(),ie.ri.mult(l,ie.ri),t.push(ie)}}m.release(G,Z,D,K,U)}function s(t,i,n,o,r,s,h,c,u){o.vsub(r,O);for(var l=n.faceNormals,p=n.faces,v=n.vertices,d=i.radius,f=0;f<v.length;f++){var y=v[f],w=R;h.vmult(y,w),r.vadd(w,w);var b=B;if(w.vsub(o,b),b.norm2()<d*d){V=!0;var x=e(c,u);return b.copy(x.ri),x.ri.normalize(),x.ri.copy(x.ni),x.ri.mult(d,x.ri),w.vsub(r,x.rj),void t.push(x)}}for(var V=!1,f=0,g=p.length;f!==g&&V===!1;f++){var E=l[f],z=p[f],S=T;h.vmult(E,S);var q=F;h.vmult(v[z[0]],q),q.vadd(r,q);var M=L;S.mult(-d,M),o.vadd(M,M);var j=k;M.vsub(q,j);var N=j.dot(S),C=W;if(o.vsub(q,C),0>N&&C.dot(S)>0){for(var P=[],U=0,D=z.length;U!==D;U++){var Q=m.get();h.vmult(v[z[U]],Q),r.vadd(Q,Q),P.push(Q)}if(a(P,S,o)){V=!0;var x=e(c,u);S.mult(-d,x.ri),S.negate(x.ni);var H=m.get();S.mult(-N,H);var X=m.get();return S.mult(-d,X),o.vsub(r,x.rj),x.rj.vadd(X,x.rj),x.rj.vadd(H,x.rj),m.release(H),m.release(X),void t.push(x)}for(var U=0;U<z.length;U++){var _=m.get(),Y=m.get();h.vmult(v[z[(U+1)%z.length]],_),h.vmult(v[z[(U+2)%z.length]],Y),r.vadd(_,_),r.vadd(Y,Y);var G=A;Y.vsub(_,G),edgeUnit=I,G.unit(edgeUnit);var Z=m.get(),K=m.get();o.vsub(_,K),edgeUnit.mult(K.dot(edgeUnit),Z),Z.vadd(_,Z);var J=m.get();if(Z.vsub(o,J),J.norm2()<d*d){var x=e(c,u);return Z.vsub(r,x.rj),Z.vsub(o,x.ni),x.ni.normalize(),x.ni.mult(d,x.ri),void t.push(x)}m.release(_),m.release(Y),m.release(Z),m.release(J),m.release(K)}for(var U=0,$=P.length;U!==$;U++)m.release(P[U])}}}function h(t,e,i,n,o,a,r,s,h){u(t,e,i.convexPolyhedronRepresentation,n,o,a,r,s,h)}function c(e,i,n,o,a,r,s,h,c){for(var u=U,l=D,p=0,v=0,d=n.childShapes.length;v!==d;v++){var y=[],m=l.pop()||new t.Quaternion,w=u.pop()||new t.Vec3;s.mult(n.childOrientations[v],m),m.normalize(),s.vmult(n.childOffsets[v],w),a.vadd(w,w),f(y,i,n.childShapes[v],o,w,r,m,h,c),l.push(m);var b=w;i||(p+=y.length);for(var x=0;x<y.length;x++)s.vmult(n.childOffsets[v],b),y[x].rj.vadd(b,y[x].rj),e.push(y[x]);u.push(w)}}function u(t,i,n,o,a,r,s,h,c){var u=Q,l=H;l.set(0,0,1),r.vmult(l,l);for(var p=X,v=0;v<n.vertices.length;v++){n.vertices[v].copy(u),s.vmult(u,u),a.vadd(u,u),u.vsub(o,p);var d=l.dot(p);if(0>=d){var f=_;l.mult(l.dot(u),f),u.vsub(f,f);var y=e(h,c);l.copy(y.ni),f.copy(y.ri),u.vsub(a,y.rj),t.push(y)}}}function l(t,i,n,o,a,r,s,h,c){var u=Y;if(i.findSeparatingAxis(n,o,r,a,s,u)){var l=[],p=G;i.clipAgainstHull(o,r,n,a,s,u,-100,100,l);for(var v=0;v<l.length;v++){var d=e(h,c);u.negate(d.ni),l[v].normal.negate(p),p.mult(l[v].depth,p),l[v].point.vadd(p,d.ri),l[v].point.copy(d.rj),d.rj.vsub(a,d.rj),d.ri.vsub(o,d.ri),t.push(d)}}}function p(t,i,n,o,a,r,s,h,c){var u=Z;u.set(0,0,1),c.quaternion.vmult(u,u);var l=K;o.vsub(c.position,l);var p=u.dot(l);if(0>=p){var v=e(h,c);u.copy(v.ni),v.ni.negate(v.ni),v.ri.set(0,0,0);var d=J;u.mult(u.dot(o),d),o.vsub(d,d),d.copy(v.rj),t.push(v)}}function v(t,i,n,o,a,r,s,h,c){var u=$;u.set(0,0,1),o.vsub(a,u);var l=u.norm2();if(l<=n.radius*n.radius){var p=e(h,c);u.normalize(),u.copy(p.rj),p.rj.mult(n.radius,p.rj),u.copy(p.ni),p.ni.negate(p.ni),p.ri.set(0,0,0),t.push(p)}}function d(i,n,o,a,r,s,h,c,u){var l=-1,p=ne,v=null,d=0,f=ee;if(a.copy(f),f.vsub(r,f),h.conjugate(te),te.vmult(f,f),o.pointIsInside(f)){for(var y=0,m=o.faces.length;y!==m;y++){for(var w=[],b=0,x=o.faces[y].length;b!==x;b++){var V=new t.Vec3;o.vertices[o.faces[y][b]].copy(V),h.vmult(V,V),V.vadd(r,V),w.push(V)}var g=ie;o.faceNormals[y].copy(g),g.normalize(),h.vmult(g,g);var E=-g.dot(a.vsub(w[0]));(null===v||Math.abs(E)<Math.abs(v))&&(v=E,l=y,g.copy(p),d++)}if(-1!==l){var z=e(c,u),S=p.mult(v),q=a.vsub(r).vadd(S);q.copy(z.rj),p.negate(z.ni),z.ri.set(0,0,0),i.push(z)}else console.warn("Point found inside convex, but did not find penetrating face!")}}function f(e,a,y,m,w,b,x,V,g){var E=!1,z=t.Shape.types;if(a&&y){if(a.type>y.type){var S;S=y,y=a,a=S,S=w,w=m,m=S,S=x,x=b,b=S,S=g,g=V,V=S,E=!0}}else if(a&&!y){var S;S=y,y=a,a=S,S=w,w=m,m=S,S=x,x=b,b=S,S=g,g=V,V=S,E=!0}if(a&&y){if(a.type==z.SPHERE)switch(y.type){case z.SPHERE:n(e,a,y,m,w,b,x,V,g);break;case z.PLANE:o(e,a,y,m,w,b,x,V,g);break;case z.BOX:r(e,a,y,m,w,b,x,V,g);break;case z.COMPOUND:c(e,a,y,m,w,b,x,V,g);break;case z.CONVEXPOLYHEDRON:s(e,a,y,m,w,b,x,V,g);break;default:console.warn("Collision between CANNON.Shape.types.SPHERE and "+y.type+" not implemented yet.")}else if(a.type==z.PLANE)switch(y.type){case z.PLANE:throw new Error("Plane-plane collision... wait, you did WHAT?");case z.BOX:h(e,a,y,m,w,b,x,V,g);break;case z.COMPOUND:c(e,a,y,m,w,b,x,V,g);break;case z.CONVEXPOLYHEDRON:u(e,a,y,m,w,b,x,V,g);break;default:console.warn("Collision between CANNON.Shape.types.PLANE and "+y.type+" not implemented yet.")}else if(a.type==z.BOX)switch(y.type){case z.BOX:f(e,a.convexPolyhedronRepresentation,y.convexPolyhedronRepresentation,m,w,b,x,V,g);break;case z.COMPOUND:c(e,a,y,m,w,b,x,V,g);break;case z.CONVEXPOLYHEDRON:f(e,a.convexPolyhedronRepresentation,y,m,w,b,x,V,g);break;default:console.warn("Collision between CANNON.Shape.types.BOX and "+y.type+" not implemented yet.")}else if(a.type==z.COMPOUND)switch(y.type){case z.COMPOUND:c(e,a,y,m,w,b,x,V,g);break;case z.CONVEXPOLYHEDRON:var q=[];c(q,y,a,w,m,x,b,g,V);for(var M=0;M<q.length;M++)i(q[M]),e.push(q[M]);break;default:console.warn("Collision between CANNON.Shape.types.COMPOUND and "+y.type+" not implemented yet.")}else if(a.type==z.CONVEXPOLYHEDRON)switch(y.type){case z.CONVEXPOLYHEDRON:l(e,a,y,m,w,b,x,V,g);break;default:console.warn("Collision between CANNON.Shape.types.CONVEXPOLYHEDRON and "+y.type+" not implemented yet.")}}else switch(y.type){case z.PLANE:p(e,a,y,m,w,b,x,V,g);break;case z.SPHERE:v(e,a,y,m,w,b,x,V,g);break;case z.BOX:d(e,a,y.convexPolyhedronRepresentation,m,w,b,x,V,g);break;case z.CONVEXPOLYHEDRON:d(e,a,y,m,w,b,x,V,g);break;case z.COMPOUND:c(e,a,y,m,w,b,x,V,g);break;default:console.warn("Collision between CANNON.Particle and "+y.type+" not implemented yet.")}for(var j=0;E&&j<e.length;j++)i(e[j])}this.contactReduction=!1;var y=[],m=new t.Vec3Pool,w=new t.Vec3,b=new t.Vec3,x=new t.Vec3,V=new t.Vec3,g=new t.Vec3,E=new t.Vec3,z=new t.Vec3,S=new t.Vec3,q=new t.Vec3,M=[new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3],j=new t.Vec3,N=new t.Vec3,C=new t.Vec3,P=new t.Vec3,O=new t.Vec3,A=new t.Vec3,I=new t.Vec3,B=new t.Vec3,R=new t.Vec3,T=new t.Vec3,F=new t.Vec3,L=new t.Vec3,k=new t.Vec3,W=new t.Vec3,U=(new t.Vec3,new t.Vec3,[]),D=[],Q=new t.Vec3,H=new t.Vec3,X=new t.Vec3,_=new t.Vec3,Y=new t.Vec3,G=new t.Vec3,Z=new t.Vec3,K=new t.Vec3,J=new t.Vec3,$=new t.Vec3,te=new t.Quaternion,ee=new t.Vec3,ie=new t.Vec3,ne=new t.Vec3;this.reduceContacts=function(){},this.getContacts=function(t,e,i,n,o){for(var a=0;o&&a<o.length;a++)y.push(o[a]);for(var r=0;r<t.length;r++){var s=t[r],h=e[r];f(n,s.shape,h.shape,s.position,h.position,s.quaternion,h.quaternion,s,h)}}},t.Equation=function(t,e,i,n){this.id=-1,this.minForce="undefined"==typeof i?-1e6:i,this.maxForce="undefined"==typeof n?1e6:n,this.bi=t,this.bj=e,this.stiffness=1e7,this.regularizationTime=5,this.a=0,this.b=0,this.eps=0,this.spookParamsNeedsUpdate=!0},t.Equation.prototype.constructor=t.Equation,t.Equation.prototype.updateSpookParams=function(t){var e=this.regularizationTime,i=this.stiffness;this.a=4/(t*(1+4*e)),this.b=4*e/(1+4*e),this.eps=4/(t*t*i*(1+4*e))},t.ContactEquation=function(e,i){t.Equation.call(this,e,i,0,1e6),this.restitution=0,this.penetration=0,this.ri=new t.Vec3,this.penetrationVec=new t.Vec3,this.rj=new t.Vec3,this.ni=new t.Vec3,this.rixn=new t.Vec3,this.rjxn=new t.Vec3,this.rixw=new t.Vec3,this.rjxw=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.relVel=new t.Vec3,this.relForce=new t.Vec3},t.ContactEquation.prototype=new t.Equation,t.ContactEquation.prototype.constructor=t.ContactEquation;var x=new t.Vec3,V=new t.Vec3;t.ContactEquation.prototype.computeB=function(e){var i=this.a,n=this.b,o=this.bi,a=this.bj,r=this.ri,s=this.rj,h=this.rixn,c=this.rjxn,u=o.velocity,l=o.angularVelocity?o.angularVelocity:new t.Vec3,p=o.force,v=o.tau?o.tau:new t.Vec3,d=a.velocity,f=a.angularVelocity?a.angularVelocity:new t.Vec3,y=a.force,m=a.tau?a.tau:new t.Vec3,w=(this.relVel,this.relForce,this.penetrationVec),b=o.invMass,g=a.invMass,E=this.invIi,z=this.invIj;o.invInertia?E.setTrace(o.invInertia):E.identity(),a.invInertia?z.setTrace(a.invInertia):z.identity();var S=this.ni;r.cross(S,h),s.cross(S,c);var w=this.penetrationVec;w.set(0,0,0),w.vadd(a.position,w),w.vadd(s,w),w.vsub(o.position,w),w.vsub(r,w);var q=S.dot(w),M=x,j=V;E.vmult(v,M),z.vmult(m,j);var N=this.restitution+1,C=N*d.dot(S)-N*u.dot(S)+f.dot(c)-l.dot(h),P=y.dot(S)*g-p.dot(S)*b+c.dot(j)-h.dot(M),O=-q*i-C*n-e*P;return O};var g=new t.Vec3,E=new t.Vec3;t.ContactEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.rixn,n=this.rjxn,o=t.invMass,a=e.invMass,r=o+a+this.eps,s=this.invIi,h=this.invIj;return t.invInertia?s.setTrace(t.invInertia):s.identity(),e.invInertia?h.setTrace(e.invInertia):h.identity(),s.vmult(i,g),h.vmult(n,E),r+=g.dot(i),r+=E.dot(n)};var z=new t.Vec3;t.ContactEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=z,n=0;return e.vlambda.vsub(t.vlambda,i),n+=i.dot(this.ni),t.wlambda&&(n-=t.wlambda.dot(this.rixn)),e.wlambda&&(n+=e.wlambda.dot(this.rjxn)),n};var S=new t.Vec3,q=new t.Vec3;t.ContactEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=this.rixn,o=this.rjxn,a=e.invMass,r=i.invMass,s=this.ni,h=S,c=q;if(s.mult(a*t,c),e.vlambda.vsub(c,e.vlambda),s.mult(r*t,c),i.vlambda.vadd(c,i.vlambda),e.wlambda){var u=this.invIi;u.vmult(n,h),h.mult(t,h),e.wlambda.vsub(h,e.wlambda)}if(i.wlambda){var u=this.invIj;u.vmult(o,h),h.mult(t,h),i.wlambda.vadd(h,i.wlambda)}},t.FrictionEquation=function(e,i,n){t.Equation.call(this,e,i,-n,n),this.ri=new t.Vec3,this.rj=new t.Vec3,this.t=new t.Vec3,this.rixt=new t.Vec3,this.rjxt=new t.Vec3,this.wixri=new t.Vec3,this.wjxrj=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.relVel=new t.Vec3,this.relForce=new t.Vec3},t.FrictionEquation.prototype=new t.Equation,t.FrictionEquation.prototype.constructor=t.FrictionEquation;var M=new t.Vec3,N=new t.Vec3;t.FrictionEquation.prototype.computeB=function(e){var i=this.a,n=this.b,o=this.bi,a=this.bj,r=this.ri,s=this.rj,h=this.rixt,c=this.rjxt,u=this.wixri,l=this.wjxrj,p=o.velocity,v=o.angularVelocity?o.angularVelocity:new t.Vec3,d=o.force,f=o.tau?o.tau:new t.Vec3,y=a.velocity,m=a.angularVelocity?a.angularVelocity:new t.Vec3,w=a.force,b=a.tau?a.tau:new t.Vec3,x=(this.relVel,this.relForce,o.invMass),V=a.invMass,g=this.invIi,E=this.invIj;o.invInertia&&g.setTrace(o.invInertia),a.invInertia&&E.setTrace(a.invInertia);var z=this.t;r.cross(z,h),s.cross(z,c),v.cross(r,u),m.cross(s,l);var S=M,q=N;g.vmult(f,S),E.vmult(b,q);var j=0,C=y.dot(z)-p.dot(z)+l.dot(z)-u.dot(z),P=w.dot(z)*V-d.dot(z)*x+c.dot(q)-h.dot(S),O=-j*i-C*n-e*P;return O};var C=new t.Vec3,P=new t.Vec3;t.FrictionEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.rixt,n=this.rjxt,o=t.invMass,a=e.invMass,r=o+a+this.eps,s=this.invIi,h=this.invIj;return t.invInertia&&s.setTrace(t.invInertia),e.invInertia&&h.setTrace(e.invInertia),s.vmult(i,C),h.vmult(n,P),r+=C.dot(i),r+=P.dot(n)};var O=new t.Vec3;t.FrictionEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=0,n=O;return e.vlambda.vsub(t.vlambda,n),i+=n.dot(this.t),t.wlambda&&(i-=t.wlambda.dot(this.rixt)),e.wlambda&&(i+=e.wlambda.dot(this.rjxt)),i};var A=new t.Vec3;t.FrictionEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=this.rixt,o=this.rjxt,a=e.invMass,r=i.invMass,s=this.t,h=A;s.mult(a*t,h),e.vlambda.vsub(h,e.vlambda),s.mult(r*t,h),i.vlambda.vadd(h,i.vlambda);var c=e.wlambda;if(c){var u=this.invIi;u.vmult(n,h),h.mult(t,h),c.vsub(h,c)}var l=i.wlambda;if(l){var u=this.invIj;u.vmult(o,h),h.mult(t,h),l.vadd(h,l)}},t.RotationalEquation=function(e,i){t.Equation.call(this,e,i,-1e6,1e6),this.ni=new t.Vec3,this.nj=new t.Vec3,this.nixnj=new t.Vec3,this.njxni=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.relVel=new t.Vec3,this.relForce=new t.Vec3},t.RotationalEquation.prototype=new t.Equation,t.RotationalEquation.prototype.constructor=t.RotationalEquation,t.RotationalEquation.prototype.computeB=function(e){var i=this.a,n=this.b,o=this.bi,a=this.bj,r=this.ni,s=this.nj,h=this.nixnj,c=this.njxni,u=(o.velocity,o.angularVelocity?o.angularVelocity:new t.Vec3),l=(o.force,o.tau?o.tau:new t.Vec3,a.velocity,a.angularVelocity?a.angularVelocity:new t.Vec3),p=(a.force,a.tau?a.tau:new t.Vec3,o.invMass,a.invMass,this.invIi),v=this.invIj;o.invInertia?p.setTrace(o.invInertia):p.identity(),a.invInertia?v.setTrace(a.invInertia):v.identity(),r.cross(s,h),s.cross(r,c);var d=-r.dot(s),f=c.dot(u)+h.dot(l),y=0,m=-d*i-f*n-e*y;return m},t.RotationalEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.nixnj,n=this.njxni,o=(t.invMass,e.invMass,this.eps),a=this.invIi,r=this.invIj;return t.invInertia?a.setTrace(t.invInertia):a.identity(),e.invInertia?r.setTrace(e.invInertia):r.identity(),o+=a.vmult(n).dot(n),o+=r.vmult(i).dot(i)};var z=new t.Vec3;t.RotationalEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=0;return t.wlambda&&(i+=t.wlambda.dot(this.njxni)),e.wlambda&&(i+=e.wlambda.dot(this.nixnj)),i},t.RotationalEquation.prototype.addToWlambda=function(t){{var e=this.bi,i=this.bj,n=this.nixnj;this.njxni,e.invMass,i.invMass}if(e.wlambda){var o=this.invIi;e.wlambda.vsub(o.vmult(n).mult(t),e.wlambda)}if(i.wlambda){var o=this.invIj;i.wlambda.vadd(o.vmult(n).mult(t),i.wlambda)}},t.Constraint=function(t,e){this.equations=[],this.bodyA=t,this.bodyB=e},t.Constraint.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},t.DistanceConstraint=function(e,i,n,o){t.Constraint.call(this,e,i),"undefined"==typeof o&&(o=1e6);var a=this.equations=[new t.ContactEquation(e,i)],r=a[0];r.minForce=-o,r.maxForce=o,this.update=function(){i.position.vsub(e.position,r.ni),r.ni.normalize(),r.ni.mult(.5*n,r.ri),r.ni.mult(.5*-n,r.rj)}},t.DistanceConstraint.prototype=new t.Constraint,t.RotationalMotorEquation=function(e,i,n){n=n||1e6,t.Equation.call(this,e,i,-n,n),this.axisA=new t.Vec3,this.axisB=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.targetVelocity=0},t.RotationalMotorEquation.prototype=new t.Equation,t.RotationalMotorEquation.prototype.constructor=t.RotationalMotorEquation,t.RotationalMotorEquation.prototype.computeB=function(e){var i=this.a,n=this.b,o=this.bi,a=this.bj,r=this.axisA,s=this.axisB,h=(o.velocity,o.angularVelocity?o.angularVelocity:new t.Vec3),c=(o.force,o.tau?o.tau:new t.Vec3,a.velocity,a.angularVelocity?a.angularVelocity:new t.Vec3),u=(a.force,a.tau?a.tau:new t.Vec3,o.invMass,a.invMass,this.invIi),l=this.invIj;o.invInertia?u.setTrace(o.invInertia):u.identity(),a.invInertia?l.setTrace(a.invInertia):l.identity();var p=0,v=r.dot(h)+s.dot(c)+this.targetVelocity,d=0,f=-p*i-v*n-e*d;return f},t.RotationalMotorEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.axisA,n=this.axisB,o=(t.invMass,e.invMass,this.eps),a=this.invIi,r=this.invIj;return t.invInertia?a.setTrace(t.invInertia):a.identity(),e.invInertia?r.setTrace(e.invInertia):r.identity(),o+=a.vmult(i).dot(n),o+=r.vmult(n).dot(n)};var z=new t.Vec3;t.RotationalMotorEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=this.axisA,n=this.axisB,o=0;return t.wlambda&&(o+=t.wlambda.dot(i)),e.wlambda&&(o+=e.wlambda.dot(n)),o},t.RotationalMotorEquation.prototype.addToWlambda=function(t){{var e=this.bi,i=this.bj,n=this.axisA,o=this.axisB;e.invMass,i.invMass}if(e.wlambda){var a=this.invIi;e.wlambda.vsub(a.vmult(n).mult(t),e.wlambda)}if(i.wlambda){var a=this.invIj;i.wlambda.vadd(a.vmult(o).mult(t),i.wlambda)}},t.HingeConstraint=function(e,i,n,o,a,r,s){t.Constraint.call(this,e,o),s=s||1e6;var h=this,c=this.equations=[new t.RotationalEquation(e,o),new t.RotationalEquation(e,o),new t.ContactEquation(e,o),new t.ContactEquation(e,o),new t.ContactEquation(e,o)];this.getRotationalEquation1=function(){return c[0]},this.getRotationalEquation2=function(){return c[1]},this.getPointToPointEquation1=function(){return c[2]},this.getPointToPointEquation2=function(){return c[3]},this.getPointToPointEquation3=function(){return c[4]};var u,l=this.getRotationalEquation1(),p=this.getRotationalEquation2(),v=this.getPointToPointEquation1(),d=this.getPointToPointEquation2(),f=this.getPointToPointEquation3();d.minForce=f.minForce=v.minForce=-s,d.maxForce=f.maxForce=v.maxForce=s;var y=i.unit(),m=a.unit(),w=n.cross(y),b=n.cross(w),x=r.cross(m);w.normalize(),x.normalize();var V=!1;this.motorTargetVelocity=0,this.motorMinForce=-s,this.motorMaxForce=s,this.enableMotor=function(){V||(u=new t.RotationalMotorEquation(e,o,s),c.push(u),V=!0)},this.disableMotor=function(){V&&(V=!1,u=null,c.pop())},this.update=function(){v.ni.set(1,0,0),d.ni.set(0,1,0),f.ni.set(0,0,1),e.quaternion.vmult(i,v.ri),o.quaternion.vmult(a,v.rj),v.ri.copy(d.ri),v.rj.copy(d.rj),v.ri.copy(f.ri),v.rj.copy(f.rj),e.quaternion.vmult(w,l.ni),o.quaternion.vmult(r,l.nj),e.quaternion.vmult(b,p.ni),o.quaternion.vmult(r,p.nj),V&&(e.quaternion.vmult(n,u.axisA),o.quaternion.vmult(r,u.axisB),u.targetVelocity=h.motorTargetVelocity,u.maxForce=h.motorMaxForce,u.minForce=h.motorMinForce)}},t.HingeConstraint.prototype=new t.Constraint,t.PointToPointConstraint=function(e,i,n,o,a){t.Constraint.call(this,e,n);var r=this.equations=[new t.ContactEquation(e,n),new t.ContactEquation(e,n),new t.ContactEquation(e,n)],s=r[0],h=r[1],c=r[2];h.minForce=c.minForce=s.minForce=-a,h.maxForce=c.maxForce=s.maxForce=a,this.update=function(){n.position.vsub(e.position,s.ni),s.ni.normalize(),e.quaternion.vmult(i,s.ri),n.quaternion.vmult(o,s.rj),s.ni.tangents(h.ni,c.ni),s.ri.copy(h.ri),s.rj.copy(h.rj),s.ri.copy(c.ri),s.rj.copy(c.rj)}},t.PointToPointConstraint.prototype=new t.Constraint,"undefined"!=typeof module?module.exports=t:this.CANNON=t}).apply(this);